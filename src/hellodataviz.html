<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hello DataViz</title>
    <script src="https://cdn.zingchart.com/zingchart.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f9; }
        h2 { margin-top: 40px; }
        .chart-container {
            margin: 20px auto;
            width: 80%;
            height: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>Hello DataViz</h1>

    <h2>Page Load Times (Line Chart)</h2>
    <div id="lineChart" class="chart-container"></div>

    <h2>User Events (Bar Chart)</h2>
    <div id="barChart" class="chart-container"></div>

    <h2>User Languages (Pie Chart)</h2>
    <div id="pieChart" class="chart-container"></div>

    <script>
        // Helper to generate random colors for pie slices
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) color += letters[Math.floor(Math.random() * 16)];
            return color;
        }

        // --- Line Chart: Page Load Times ---
        async function loadPerformanceData() {
            const res = await fetch('/api/performance');
            const perfData = await res.json();

            // Convert timestamps to Date objects
            perfData.forEach(d => {
                d.collectedAtDate = d.collectedAt ? new Date(d.collectedAt) : new Date();
            });

            const pages = [...new Set(perfData.map(d => d.pagePath || d.page))];
            const series = pages.map(page => ({
                text: page,
                values: perfData
                    .filter(d => (d.pagePath || d.page) === page)
                    .map(d => d.loadTime || (d.navigation && d.navigation.loadTime) || 0)
            }));

            const labels = perfData.map(d => d.collectedAtDate.toLocaleTimeString());

            zingchart.render({
                id: 'lineChart',
                data: {
                    type: 'line',
                    title: { text: "Page Load Times" },
                    scaleX: { labels },
                    series
                },
                height: '100%',
                width: '100%'
            });
        }

        // --- Bar Chart: Clicks, Scrolls, Mouse Moves ---
        async function loadActivityData() {
            const res = await fetch('/api/activity');
            const actData = await res.json();

            const eventCounts = actData.reduce((acc, d) => {
                const type = d.type || d.event;
                acc[type] = (acc[type] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(eventCounts);
            const clicks = labels.map(l => l === 'click' ? eventCounts[l] : 0);
            const scrolls = labels.map(l => l === 'scroll' ? eventCounts[l] : 0);
            const mousemoves = labels.map(l => l === 'mousemove' ? eventCounts[l] : 0);

            zingchart.render({
                id: 'barChart',
                data: {
                    type: 'bar',
                    title: { text: "User Events by Type" },
                    scaleX: { labels },
                    series: [
                        { text: "Clicks", values: clicks },
                        { text: "Scrolls", values: scrolls },
                        { text: "Mouse Moves", values: mousemoves }
                    ]
                },
                height: '100%',
                width: '100%'
            });
        }

        // --- Pie Chart: User Languages ---
        async function loadStaticData() {
            const res = await fetch('/api/static');
            const staticData = await res.json();

            const counts = staticData.reduce((acc, d) => {
                const lang = d.language || "unknown";
                acc[lang] = (acc[lang] || 0) + 1;
                return acc;
            }, {});

            zingchart.render({
                id: 'pieChart',
                data: {
                    type: 'pie',
                    title: { text: "User Languages" },
                    series: Object.entries(counts).map(([lang, count]) => ({
                        text: lang,
                        values: [count],
                        backgroundColor: getRandomColor()
                    })),
                    plot: {
                        valueBox: {
                            visible: true,
                            type: 'all',
                            text: '%t: %v',
                            fontSize: 14,
                            placement: 'out'
                        }
                    }
                },
                height: '100%',
                width: '100%'
            });
        }

        // --- Run all charts ---
        loadPerformanceData();
        loadActivityData();
        loadStaticData();
    </script>
</body>
</html>
